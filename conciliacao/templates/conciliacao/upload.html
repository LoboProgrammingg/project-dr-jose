{% extends "base.html" %}

{% block title %}Nova Conciliação{% endblock %}
{% block page_title %}Nova Conciliação Bancária{% endblock %}

{% block content %}
<div class="mx-auto max-w-4xl">
    <!-- Cabeçalho da Página -->
    <div class="text-center">
        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" />
        </svg>
        <h1 class="mt-2 text-3xl font-bold tracking-tight text-gray-900 sm:text-4xl">Iniciar Nova Conciliação</h1>
        <p class="mt-2 text-lg leading-8 text-gray-600">Faça o upload dos dois arquivos necessários para gerar e salvar o relatório de conciliação.</p>
    </div>

    <!-- Link para o Histórico -->
    <div class="text-center mt-4">
        <a href="{% url 'conciliacao:lista_relatorios' %}" class="text-sm font-semibold leading-6 text-indigo-600 hover:text-indigo-500">Ver Histórico de Conciliações &rarr;</a>
    </div>

    <!-- Formulário Principal -->
    <div class="mt-10 bg-white p-8 rounded-xl shadow-lg ring-1 ring-gray-900/5">
        <form method="post" enctype="multipart/form-data" class="space-y-8">
            {% csrf_token %}

            <!-- Seção de Upload de Arquivos -->
            <div class="grid grid-cols-1 gap-x-8 gap-y-10 border-b border-gray-900/10 pb-10 md:grid-cols-2">
                
                <!-- Input para Arquivo OFX -->
                <div>
                    <label for="arquivo_ofx" class="block text-base font-semibold leading-7 text-gray-900">1. Extrato do Banco</label>
                    <div id="dropzone-ofx" class="mt-2 flex justify-center rounded-lg border border-dashed border-gray-900/25 px-6 py-10 transition hover:border-gray-400">
                        <div class="text-center">
                            <svg class="mx-auto h-12 w-12 text-gray-300" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                                <path fill-rule="evenodd" d="M1.5 6a2.25 2.25 0 012.25-2.25h16.5A2.25 2.25 0 0122.5 6v12A2.25 2.25 0 0120.25 20.25H3.75A2.25 2.25 0 011.5 18V6zM3 16.06V18c0 .414.336.75.75.75h16.5A.75.75 0 0021 18v-1.94l-2.69-2.689a1.5 1.5 0 00-2.12 0l-.88.879.97.97a.75.75 0 11-1.06 1.06l-5.16-5.159a1.5 1.5 0 00-2.12 0L3 16.061zm10.125-7.81a1.125 1.125 0 112.25 0 1.125 1.125 0 01-2.25 0z" clip-rule="evenodd" />
                            </svg>
                            <div class="mt-4 flex text-sm leading-6 text-gray-600">
                                <label for="arquivo_ofx" class="relative cursor-pointer rounded-md bg-white font-semibold text-indigo-600 focus-within:outline-none focus-within:ring-2 focus-within:ring-indigo-600 focus-within:ring-offset-2 hover:text-indigo-500">
                                    <span>Selecione um arquivo</span>
                                    <input id="arquivo_ofx" name="arquivo_ofx" type="file" class="sr-only" required accept=".ofx">
                                </label>
                                <p class="pl-1">ou arraste e solte</p>
                            </div>
                            <p class="text-xs leading-5 text-gray-600">Arquivo .OFX</p>
                            <p id="filename-ofx" class="mt-2 text-sm font-medium text-green-600"></p>
                        </div>
                    </div>
                </div>

                <!-- Input para Arquivo CSV -->
                <div>
                    <label for="arquivo_csv" class="block text-base font-semibold leading-7 text-gray-900">2. Relatório do Gestor</label>
                    <div id="dropzone-csv" class="mt-2 flex justify-center rounded-lg border border-dashed border-gray-900/25 px-6 py-10 transition hover:border-gray-400">
                        <div class="text-center">
                            <svg class="mx-auto h-12 w-12 text-gray-300" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                                <path fill-rule="evenodd" d="M3 3.75A.75.75 0 013.75 3h16.5a.75.75 0 01.75.75v16.5a.75.75 0 01-.75.75H3.75a.75.75 0 01-.75-.75V3.75zM9 6a.75.75 0 01.75.75v1.5a.75.75 0 01-1.5 0V6.75A.75.75 0 019 6zm-3 3.75a.75.75 0 01.75-.75h1.5a.75.75 0 010 1.5h-1.5a.75.75 0 01-.75-.75zM9 9.75a.75.75 0 01.75.75v1.5a.75.75 0 01-1.5 0v-1.5A.75.75 0 019 9.75zm3 0a.75.75 0 01.75.75v1.5a.75.75 0 01-1.5 0v-1.5A.75.75 0 0112 9.75zM6 13.5a.75.75 0 01.75-.75h1.5a.75.75 0 010 1.5h-1.5A.75.75 0 016 13.5zm3 0a.75.75 0 01.75-.75h1.5a.75.75 0 010 1.5h-1.5A.75.75 0 019 13.5zm3 0a.75.75 0 01.75-.75h1.5a.75.75 0 010 1.5h-1.5a.75.75 0 01-.75-.75zM6 17.25a.75.75 0 01.75-.75h1.5a.75.75 0 010 1.5h-1.5a.75.75 0 01-.75-.75zm3 0a.75.75 0 01.75-.75h1.5a.75.75 0 010 1.5h-1.5a.75.75 0 01-.75-.75zm3 0a.75.75 0 01.75-.75h1.5a.75.75 0 010 1.5h-1.5a.75.75 0 01-.75-.75zM15 6.75a.75.75 0 01-1.5 0v1.5a.75.75 0 011.5 0V6.75z" clip-rule="evenodd" />
                            </svg>
                            <div class="mt-4 flex text-sm leading-6 text-gray-600">
                                <label for="arquivo_csv" class="relative cursor-pointer rounded-md bg-white font-semibold text-indigo-600 focus-within:outline-none focus-within:ring-2 focus-within:ring-indigo-600 focus-within:ring-offset-2 hover:text-indigo-500">
                                    <span>Selecione um arquivo</span>
                                    <input id="arquivo_csv" name="arquivo_csv" type="file" class="sr-only" required accept=".csv">
                                </label>
                                <p class="pl-1">ou arraste e solte</p>
                            </div>
                            <p class="text-xs leading-5 text-gray-600">Arquivo .CSV</p>
                            <p id="filename-csv" class="mt-2 text-sm font-medium text-green-600"></p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Botão de Submissão -->
            <div class="mt-6 flex items-center justify-end gap-x-6">
                <button type="submit" class="w-full rounded-md bg-indigo-600 px-3 py-3 text-lg font-semibold text-white shadow-sm hover:bg-indigo-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-600">
                    Processar e Salvar Conciliação
                </button>
            </div>
        </form>
    </div>

    <!-- Bloco de Erro -->
    {% if error %}
    <div class="mt-6 rounded-md bg-red-50 p-4">
        <div class="flex">
            <div class="flex-shrink-0">
                <svg class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.28 7.22a.75.75 0 00-1.06 1.06L8.94 10l-1.72 1.72a.75.75 0 101.06 1.06L10 11.06l1.72 1.72a.75.75 0 101.06-1.06L11.06 10l1.72-1.72a.75.75 0 00-1.06-1.06L10 8.94 8.28 7.22z" clip-rule="evenodd" /></svg>
            </div>
            <div class="ml-3">
                <h3 class="text-sm font-medium text-red-800">Ocorreu um erro ao processar os arquivos</h3>
                <div class="mt-2 text-sm text-red-700">
                    <p>{{ error }}</p>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Script para feedback visual do nome do arquivo -->
<script>
    document.getElementById('arquivo_ofx').addEventListener('change', function(e){
        var fileName = e.target.files[0].name;
        document.getElementById('filename-ofx').textContent = 'Arquivo selecionado: ' + fileName;
    });
    document.getElementById('arquivo_csv').addEventListener('change', function(e){
        var fileName = e.target.files[0].name;
        document.getElementById('filename-csv').textContent = 'Arquivo selecionado: ' + fileName;
    });
</script>
{% endblock %}
