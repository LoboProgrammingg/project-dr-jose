{% extends "base.html" %}

{% block title %}Editor: {{ planilha.nome }}{% endblock %}

{% block head_extra %}
<style>
    .active-row {
        background-color: #f0f9ff; /* Azul bem claro */
    }
    .dark .active-row {
        background-color: rgba(59, 130, 246, 0.1); /* Azul mais escuro para o modo escuro */
    }
</style>
{% endblock %}

{% block content %}
<div class="grid grid-cols-1 lg:grid-cols-3 gap-x-8 gap-y-6">

    <div class="lg:col-span-1 space-y-6">
        <div>
            <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Editor de Planilha</h1>
            <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">Modifique os dados e clique em salvar.</p>
        </div>

        <div class="flex items-center gap-x-3">
            <a href="{% url 'planilhas:detalhe_ano' ano=planilha.ano_referencia.ano %}" class="inline-flex items-center gap-x-2 rounded-xl bg-white dark:bg-gray-700 px-4 py-2.5 text-sm font-semibold text-gray-900 dark:text-gray-100 shadow-sm ring-1 ring-inset ring-gray-300 dark:ring-gray-600 hover:bg-gray-50 dark:hover:bg-gray-600">
                <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M12.79 5.23a.75.75 0 01-.02 1.06L8.832 10l3.938 3.71a.75.75 0 11-1.04 1.08l-4.5-4.25a.75.75 0 010-1.08l4.5-4.25a.75.75 0 011.06.02z" clip-rule="evenodd" /></svg>
                Voltar
            </a>
            <button id="btn-salvar" class="inline-flex items-center justify-center gap-x-2 rounded-xl bg-brand-600 px-4 py-2.5 text-sm font-semibold text-white shadow-sm hover:bg-brand-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-brand-600 disabled:opacity-50 disabled:cursor-not-allowed">
                <svg id="spinner-salvar" class="animate-spin -ml-1 mr-2 h-5 w-5 text-white" style="display: none;" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                <svg id="icone-salvar" class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M10.75 2.75a.75.75 0 00-1.5 0v8.614L6.295 8.235a.75.75 0 10-1.09 1.03l4.25 4.5a.75.75 0 001.09 0l4.25-4.5a.75.75 0 00-1.09-1.03l-2.955 3.129V2.75Z" /><path d="M3.5 12.75a.75.75 0 00-1.5 0v2.5A2.75 2.75 0 004.75 18h10.5A2.75 2.75 0 0018 15.25v-2.5a.75.75 0 00-1.5 0v2.5c0 .69-.56 1.25-1.25 1.25H4.75c-.69 0-1.25-.56-1.25-1.25v-2.5Z" /></svg>
                <span id="texto-salvar">Salvar Alterações</span>
            </button>
        </div>
        
        <div class="space-y-4">
             <div>
                <label for="planilha-nome" class="block text-sm font-medium text-gray-900 dark:text-white">Nome da Planilha</label>
                <input type="text" id="planilha-nome" class="mt-1 block w-full form-input">
            </div>
            <div>
                <button id="btn-adicionar-linha" class="w-full text-sm font-semibold text-brand-600 hover:text-brand-500 flex items-center justify-center gap-x-2 p-2.5 border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-xl hover:bg-brand-50 dark:hover:bg-brand-900/20 hover:border-brand-400 dark:hover:border-brand-500 transition-colors duration-200">
                    <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5V4.75z" /></svg>
                    Adicionar Nova Linha
                </button>
            </div>
        </div>
    </div>

    <div class="lg:col-span-2">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-soft-xl overflow-hidden ring-1 ring-gray-900/5 dark:ring-white/10">
            <div class="max-h-[75vh] overflow-auto">
                <table class="min-w-full text-sm">
                    <thead id="tabela-head" class="bg-gray-50 dark:bg-gray-700/50 sticky top-0 z-10"></thead>
                    <tbody id="tabela-body" class="divide-y divide-gray-200 dark:divide-gray-700"></tbody>
                </table>
            </div>
        </div>
    </div>

</div>

<div id="notificacao-status" style="display: none;" class="fixed bottom-5 right-5 rounded-lg px-4 py-3 text-white shadow-lg transition-opacity duration-300">
    <span id="notificacao-texto"></span>
</div>
{% csrf_token %}
{% endblock %}


{% block body_extra %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const planilhaNomeInput = document.getElementById('planilha-nome');
    const tabelaHead = document.getElementById('tabela-head');
    const tabelaBody = document.getElementById('tabela-body');
    const btnAdicionarLinha = document.getElementById('btn-adicionar-linha');
    const btnSalvar = document.getElementById('btn-salvar');
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    const notificacao = document.getElementById('notificacao-status');
    const notificacaoTexto = document.getElementById('notificacao-texto');

    const estado = {
        ...JSON.parse('{{ planilha_json|safe }}'),
        activeRowIndex: null,
    };
    
    function renderizarTabela() {
        // Salva a célula que estava focada, se houver
        const focusedElement = document.activeElement;
        const focusedRow = focusedElement.dataset ? focusedElement.dataset.row : null;
        const focusedCol = focusedElement.dataset ? focusedElement.dataset.col : null;

        tabelaHead.innerHTML = '';
        tabelaBody.innerHTML = '';

        const headerRow = document.createElement('tr');
        // ... (código para criar o cabeçalho) ...
        const thNum = document.createElement('th');
        thNum.className = 'w-12 py-3 px-3 text-left font-semibold text-gray-900 dark:text-white';
        thNum.textContent = '#';
        headerRow.appendChild(thNum);
        
        estado.colunas.forEach(coluna => {
            const th = document.createElement('th');
            th.className = 'py-3 px-3 text-left font-semibold text-gray-900 dark:text-white';
            th.textContent = coluna;
            headerRow.appendChild(th);
        });
        
        const thAcao = document.createElement('th');
        thAcao.className = 'w-16 py-3 px-3';
        headerRow.appendChild(thAcao);
        tabelaHead.appendChild(headerRow);

        estado.dados.forEach((linha, rowIndex) => {
            const tr = document.createElement('tr');
            tr.className = 'group transition-colors duration-150';
            // APLICAÇÃO DA CORREÇÃO: A classe 'active-row' é aplicada aqui durante a renderização
            if (rowIndex === estado.activeRowIndex) {
                tr.classList.add('active-row');
            }

            const tdNum = document.createElement('td');
            tdNum.className = 'px-3 py-3 text-gray-500 dark:text-gray-400';
            tdNum.textContent = rowIndex + 1;
            tr.appendChild(tdNum);

            estado.colunas.forEach((coluna, colIndex) => {
                const td = document.createElement('td');
                td.className = 'p-0';
                const input = document.createElement('input');
                input.type = 'text';
                input.className = 'w-full h-full bg-transparent border-none p-3 focus:ring-2 focus:ring-brand-500';
                input.value = linha[coluna] || '';
                input.dataset.row = rowIndex;
                input.dataset.col = colIndex;
                input.addEventListener('input', () => estado.dados[rowIndex][coluna] = input.value);
                // APLICAÇÃO DA CORREÇÃO: O evento 'focus' foi removido daqui para evitar re-renderização
                td.appendChild(input);
                tr.appendChild(td);
            });

            const tdRemover = document.createElement('td');
            tdRemover.className = 'px-3 text-center';
            const btnRemover = document.createElement('button');
            btnRemover.className = 'text-gray-400 hover:text-red-500 font-bold opacity-0 group-hover:opacity-100 transition-opacity';
            btnRemover.innerHTML = '&times;';
            btnRemover.onclick = () => removerLinha(rowIndex);
            tdRemover.appendChild(btnRemover);
            tr.appendChild(tdRemover);

            tabelaBody.appendChild(tr);
        });

        // Restaura o foco na célula correta após a renderização
        if (focusedRow !== null) {
            const inputToFocus = document.querySelector(`[data-row='${focusedRow}'][data-col='${focusedCol}']`);
            if (inputToFocus) inputToFocus.focus();
        }
    }
    
    // APLICAÇÃO DA CORREÇÃO: Nova função para gerenciar o highlight de forma eficiente
    // Usamos 'focusin' na tabela inteira (event delegation)
    tabelaBody.addEventListener('focusin', (e) => {
        if (e.target.tagName !== 'INPUT') return;

        const rowIndex = parseInt(e.target.dataset.row);
        
        // Se a linha clicada não é a que já estava ativa
        if (rowIndex !== estado.activeRowIndex) {
            // Remove a classe da linha antiga, se existir
            if (estado.activeRowIndex !== null) {
                const oldRow = tabelaBody.rows[estado.activeRowIndex];
                if(oldRow) oldRow.classList.remove('active-row');
            }
            // Adiciona a classe na linha nova
            const newRow = e.target.closest('tr');
            if(newRow) newRow.classList.add('active-row');

            // Atualiza o estado
            estado.activeRowIndex = rowIndex;
        }
    });


    function adicionarLinha() {
        const novaLinha = {};
        estado.colunas.forEach(coluna => { novaLinha[coluna] = ''; });
        estado.dados.push(novaLinha);
        estado.activeRowIndex = estado.dados.length - 1; // Torna a nova linha ativa
        renderizarTabela();
    }

    function removerLinha(index) {
        if (confirm('Tem certeza que deseja remover esta linha?')) {
            estado.dados.splice(index, 1);
            if (estado.activeRowIndex === index || estado.activeRowIndex >= estado.dados.length) {
                estado.activeRowIndex = null;
            }
            renderizarTabela();
        }
    }

    function salvarDados() {
        // Lógica de salvar permanece a mesma, já está correta.
        // ...
        estado.nome = planilhaNomeInput.value;
        const btnUi = {
            texto: document.getElementById('texto-salvar'),
            icone: document.getElementById('icone-salvar'),
            spinner: document.getElementById('spinner-salvar'),
        };
        btnSalvar.disabled = true;
        btnUi.texto.textContent = 'Salvando...';
        btnUi.spinner.style.display = 'inline-block';
        btnUi.icone.style.display = 'none';

        fetch(window.location.pathname, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
            body: JSON.stringify({ nome: estado.nome, colunas: estado.colunas, dados: estado.dados })
        })
        .then(response => response.json())
        .then(data => mostrarNotificacao(data.message, data.status))
        .catch(error => mostrarNotificacao('Erro de conexão ao salvar.', 'error'))
        .finally(() => {
            btnSalvar.disabled = false;
            btnUi.texto.textContent = 'Salvar Alterações';
            btnUi.spinner.style.display = 'none';
            btnUi.icone.style.display = 'inline-block';
        });
    }
    
    function mostrarNotificacao(mensagem, tipo = 'success') {
        notificacaoTexto.textContent = mensagem;
        notificacao.className = 'fixed bottom-5 right-5 rounded-lg px-4 py-3 text-white shadow-lg transition-opacity duration-300';
        notificacao.classList.add(tipo === 'success' ? 'bg-green-600' : 'bg-red-600');
        notificacao.style.display = 'block';
        setTimeout(() => notificacao.style.display = 'none', 3000);
    }

    // A lógica de navegação por teclado permanece a mesma, já está correta.
    tabelaBody.addEventListener('keydown', (e) => {
        if (!['ArrowUp', 'ArrowDown', 'Enter', 'Tab'].includes(e.key)) return;
        if (e.target.tagName !== 'INPUT') return;

        e.preventDefault();
        const { row, col } = e.target.dataset;
        let currentRow = parseInt(row);
        let currentCol = parseInt(col);

        if (e.key === 'ArrowUp' && currentRow > 0) currentRow--;
        if ((e.key === 'ArrowDown' || e.key === 'Enter') && currentRow < estado.dados.length - 1) currentRow++;
        if (e.key === 'Tab') {
            if (e.shiftKey) {
                if (currentCol > 0) currentCol--;
                else if (currentRow > 0) {
                    currentRow--;
                    currentCol = estado.colunas.length - 1;
                }
            } else {
                if (currentCol < estado.colunas.length - 1) currentCol++;
                else if (currentRow < estado.dados.length - 1) {
                    currentRow++;
                    currentCol = 0;
                }
            }
        }
        
        const nextInput = document.querySelector(`[data-row='${currentRow}'][data-col='${currentCol}']`);
        if (nextInput) {
           nextInput.focus();
           nextInput.select(); // Seleciona o texto da próxima célula para facilitar a digitação
        }
    });

    // --- Inicialização ---
    planilhaNomeInput.value = estado.nome;
    renderizarTabela();
    btnAdicionarLinha.addEventListener('click', adicionarLinha);
    btnSalvar.addEventListener('click', salvarDados);
});
</script>
{% endblock %}